<!DOCTYPE HTML>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial;
            text-align: center;
            margin: 0px auto;
            padding-top: 30px;
            font-size: 16px;
            background-color: #292727;
            color: #e4e8e4;
        }

        .ad {
            text-align: center;
            position: absolute;
            top: 0px;
            width: 100%;
            padding: 0.5rem 0px;
            margin: 0px auto;
            color: #a3acafcf;
            font-weight: bolder;
        }

        .tab {
            overflow: hidden;
            /* border: 1px solid #ccc; */
            background-color: #1e1d1d4f;
            width: 100%;
            /* max-width: 600px; */
            margin: 0 auto;
            height: 2.5rem;
            position: absolute;
            bottom: 0px;

        }

        .tab .tablinks {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            width: 33.33%;
            color: white;
            font-size: medium;
            font-weight: bold;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            width: 50%;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #cccccc59;
        }

        .tabcontent {
            display: none;
            padding: 6px 12px;
            /* border: 1px solid #ccc; */
            width: 80%;
            max-width: 600px;
            margin: 0 auto;
            text-align: left;
        }

        .button {
            background-color: #70737ed6;
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 8px;
        }

        .input-group {
            margin: 15px auto;
            width: 80%;
            max-width: 400px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .state {
            font-weight: bold;
            margin: 20px 0px;
        }

        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .connect-btn {
            background-color: #008CBA;
            padding: 8px 16px;
            font-size: 14px;
        }

        .clear-config-btn {
            background-color: #f44336;
            padding: 8px 16px;
            font-size: 14px;
        }

        .ip-address {
            color: #4CAF50;
            font-weight: bold;
        }

        .info-item {
            margin: 14px 0;
            /* border: 1px solid #ddd; */
            /* border-radius: 5px; */
            width: 100%;
        }

        .info-label {
            font-weight: bold;
            display: inline-block;
            width: 150px;
        }

        .psram-enabled {
            color: green;
            font-weight: bold;
        }

        .psram-disabled {
            color: red;
            font-weight: bold;
        }

        /* 电机控制样式 */
        .motor-control {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .motor-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .slider-container {
            margin: 10px 0;
        }

        .slider-label {
            display: inline-block;
            width: 100px;
            font-size: 0.8rem;
        }

        .motor-slider {
            width: 70%;
        }

        .motor-button {
            margin: 5px;
            padding: 8px 16px;
        }

        .icon-forward {
            display: block;
            width: 1rem;
            width: 1rem;
            margin: auto;
            transform: rotate(90deg);
        }

        .icon-backward {
            display: block;
            width: 1rem;
            width: 1rem;
            margin: auto;
            transform: rotate(270deg);
        }

        .icon-left {
            display: block;
            width: 1rem;
            width: 1rem;
            margin: auto;
            transform: rotate(0deg);
        }

        .icon-right {
            display: block;
            width: 1rem;
            width: 1rem;
            margin: auto;
            transform: rotate(180deg);
        }

        #monitor-cpu {
            font-size: 0.8rem;
            color: #52b6e1;
        }

        .camera-tip {
            position: absolute;
            top: 0px;
        }

        .camera-viewer {
            max-width: 75%;
            height: auto;
            position: relative;
            top: -4px;
            z-index: 100;
            border: 10px solid #404340;
            transform: rotate(270deg);
        }


        /* 增加媒体查询以适应横屏幕设备 */
        @media screen and (min-width: 800px) {
            #systemInfo {
                display: flex;
                flex-wrap: wrap;
            }

            .ad {
                position: absolute;
                top: unset;
                bottom: 0px;
            }


            .screen {
                position: absolute;
                top: 60px;
                left: calc(50% - 150px);
                width: 280px;
                height: 280px;
                border-radius: 50%;
                background-color: #404340;
                box-shadow: 0 0 74px #ffffff4f inset;
                text-align: center;
                line-height: 280px;
                border: 10px solid #1f202100;
                color: #4CAF50;

            }

            .screen-after {
                position: absolute;
                top: 86px;
                left: 0px;
                width: 100%;
                height: 210px;
                background-color: #4d4f50;
                box-shadow: 0 0 40px #8e8e8e inset;
            }

            #Control {
                width: calc(100% - 24px);
                max-width: 100%;
                border: none;
            }

            .tab {
                top: 0px;

            }

            .component {
                position: absolute;
                border: none;
                top: 55px;
            }

            .component-left {
                left: 0px;
            }

            .circle {
                height: 3rem;
                width: 3rem;
                padding: 0px !important;
                text-align: text !important;
                vertical-align: middle;
                border-radius: 50%;
            }

            .component-right {
                right: 0px;
            }

            .motor-control {
                display: inline-block;
                width: 25%;
                vertical-align: top;
            }

            .direction {
                width: 200px;
                height: 200px;
                display: block;
                position: relative;

            }


            .op-forward,
            .op-backward,
            .op-left,
            .op-right,
            .op-stop {
                position: absolute;
            }

            .top-loc {
                top: 0px;
            }


            .bottom-loc {
                bottom: 0px;
            }

            .vertical-loc {
                left: calc(50% - 1.5rem);
            }

            .horizontal-loc {
                bottom: calc(50% - 1.5rem);
            }

            .left-loc {
                left: 0px;
            }

            .right-loc {
                right: 0px;
            }
        }
    </style>
</head>

<body>

    <!-- Tab content -->
    <div id="Configuration" class="tabcontent">
        <h4>WiFi配置</h4>
        <p>开发板IP: <span id="apIpAddress"></span></p>

        <div class="state">
            WiFi状态: <span id="wifiStateConfig"></span>
        </div>

        <div style=" margin: 20px auto; text-align: left;">
            <h4>连接WiFi</h4>
            <div class="input-group">
                <label for="ssid">WiFi名称:</label>
                <input type="text" id="ssid" placeholder="输入WiFi名称">
            </div>
            <div class="input-group">
                <label for="password">密码:</label>
                <input type="password" id="password" placeholder="输入WiFi密码">
            </div>
            <button class="button" onclick="connectToWiFi()">连接</button>
            <button class="button clear-config-btn" onclick="clearWiFiConfig()" style="margin-left: 10px;">清除配置</button>
        </div>

        <div id="connectionStatus"></div>


    </div>

    <div id="Monitoring" class="tabcontent">
        <div id="systemInfo">
            <div class="info-item">
                <span class="info-label">芯片型号:</span>
                <span id="chipModel">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">芯片频率:</span>
                <span id="cpuFreq">-</span> MHz
            </div>
            <div class="info-item">
                <span class="info-label">Flash大小:</span>
                <span id="flashSize">-</span> MB
            </div>
            <div class="info-item">
                <span class="info-label">PSRAM:</span>
                <span id="psramStatus">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">PSRAM大小:</span>
                <span id="psramSize">-</span> MB
            </div>
            <div class="info-item">
                <span class="info-label">可用PSRAM:</span>
                <span id="freePsram">-</span> KB
            </div>
            <div class="info-item">
                <span class="info-label">内存大小:</span>
                <span id="heapSize">-</span> KB
            </div>
            <div class="info-item">
                <span class="info-label">可用内存:</span>
                <span id="freeHeap">-</span> KB
            </div>
            <div class="info-item">
                <span class="info-label">最小可用内存:</span>
                <span id="minFreeHeap">-</span> KB
            </div>
            <div class="info-item">
                <span class="info-label">芯片温度:</span>
                <span id="temperature">-</span> °C
            </div>
            <div class="info-item">
                <span class="info-label">WiFi信号强度:</span>
                <span id="wifiSignal">-</span> dBm
            </div>
            <div class="info-item">
                <span class="info-label">本地IP:</span>
                <span id="localIp">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">MAC地址:</span>
                <span id="macAddress">-</span>
            </div>
        </div>
    </div>

    <div id="Control" class="tabcontent" style="display: block;">
        <div id="directionValue"
            style="text-align: center; font-weight: bolder; color: red; font-size:0.8rem; margin: 4px auto;"> D</div>
        <input type="radio" id="direction" hidden checked="false">

        <div class="screen-container">
            <div id="monitor-cpu"></div>
            <div id="photoContainer" style="margin: 20px auto; text-align: center;"></div>
            <div id="videoContainer" style="margin: 20px auto; text-align: center;"></div>

            <div class="screen-after">
                <div id="dot-line">
                    <canvas id="backgroundCanvas"></canvas>
                </div>
            </div>
            <div class="screen"></div>
        </div>



        <!-- 视频控制 -->
        <div class="motor-control component component-left">


            <!-- <div  class="motor-title">左控</div> -->
            <div class="slider-container">
                <span class="slider-label">行驶油门</span>
                <input type="range" max="255" min="100" value="100" class="motor-slider" id="motorTwoSpeed"
                    onchange="updateMotorTwoSpeed()">
                <span id="motorTwoSpeedValue">100</span>
            </div>
            <div class="slider-container">
                <span class="slider-label">转向差速</span>
                <input type="range" max="255" min="20" value="20" class="motor-slider" id="motorSubSpeed"
                    onchange="updateMotorSubSpeed()">
                <span id="motorSubSpeedValue">100</span>
            </div>
            <div style="width: 80%; max-width: 400px; margin: 20px auto; text-align: left;">
                <button class="button" onclick="capturePhoto()">拍照</button>
                <button class="button" onclick="startVideoStream()" style="margin-left: 10px;">视频流</button>
            </div>

        </div>

        <!-- 同速前进 -->
        <div class="motor-control component component-right">
            <!-- <div class="motor-title">右控</div> -->


            <div class="direction">
                <button class="button circle clear-config-btn vertical-loc horizontal-loc op-stop"
                    onclick="stopAllMotors()">停</button>
                <button class="button circle motor-button vertical-loc top-loc op-forward"
                    onclick="setMotorTwoForward()"><span class="icon-forward">&lt;</span></button>
                <button class="button circle motor-button horizontal-loc left-loc op-left"
                    onclick="setMotorTurnLeft()"><span class="icon-left">&lt;</span></button>
                <button class="button circle motor-button horizontal-loc right-loc op-right"
                    onclick="setMotorTurnRight()"><span class="icon-right">&lt;</span></button>
                <button class="button circle motor-button vertical-loc bottom-loc op-backward"
                    onclick="setMotorTwoBackward()"><span class="icon-backward">&lt;</span></button>
            </div>
        </div>




    </div>

    <!-- Tab links -->
    <div class="tab">
        <button class="tablinks " onclick="openTab(event, 'Configuration')">配置</button>
        <button class="tablinks" onclick="openTab(event, 'Monitoring')">监控</button>
        <button class="tablinks active" onclick="openTab(event, 'Control')">驾驶</button>
    </div>

    <div class="ad"> Track V1</div>

    <script>
        // 页面加载时获取初始状态
        window.onload = function () {
            updateConfigStatus();
            updateMonitoringInfo();
            // setInterval(updateConfigStatus, 10 * 1000); // 每5秒更新一次配置状态
            // setInterval(updateMonitoringInfo, 10 * 1000); // 每3秒更新一次监控信息
        };

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function updateConfigStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById("apIpAddress").innerText = data.ap_ip;
                    document.getElementById("wifiStateConfig").innerText = data.wifi_state;
                })
                .catch(error => {
                    console.error('获取状态失败:', error);
                    document.getElementById("apIpAddress").innerText = "无法获取";
                    document.getElementById("wifiStateConfig").innerText = "未知";
                });
        }

        function updateMonitoringInfo() {
            fetch('/system_info')
                .then(response => response.json())
                .then(data => {
                    var monitor_show_for_ctrl = '内存(' + data.free_heap + 'KB/' + data.heap_size + 'KB); CPU温度(' + data.temperature + '°C)';
                    if (data.psram_enabled) {
                        monitor_show_for_ctrl += '; PSRAM(' + (data.free_psram / 1024).toFixed(2) + 'MB/' + data.psram_size + 'MB)';
                    }
                    document.getElementById("monitor-cpu").innerText = monitor_show_for_ctrl;

                    document.getElementById("chipModel").innerText = data.chip_model;
                    document.getElementById("cpuFreq").innerText = data.cpu_freq;
                    document.getElementById("flashSize").innerText = data.flash_size;

                    // PSRAM信息
                    if (data.psram_enabled) {
                        document.getElementById("psramStatus").innerHTML = '<span class="psram-enabled">已启用</span>';
                        document.getElementById("psramSize").innerText = data.psram_size;
                        document.getElementById("freePsram").innerText = data.free_psram;
                    } else {
                        document.getElementById("psramStatus").innerHTML = '<span class="psram-disabled">未启用</span>';
                        document.getElementById("psramSize").innerText = "0";
                        document.getElementById("freePsram").innerText = "0";
                    }

                    document.getElementById("heapSize").innerText = data.heap_size;
                    document.getElementById("freeHeap").innerText = data.free_heap;
                    document.getElementById("minFreeHeap").innerText = data.min_free_heap;
                    document.getElementById("temperature").innerText = data.temperature;
                    document.getElementById("wifiSignal").innerText = data.wifi_signal;
                    document.getElementById("localIp").innerText = data.local_ip;
                    document.getElementById("macAddress").innerText = data.mac_address;
                })
                .catch(error => {
                    console.error('获取监控信息失败:', error);
                });
        }

        function connectToWiFi() {
            const ssid = document.getElementById("ssid").value;
            const password = document.getElementById("password").value;

            if (ssid.trim() === "") {
                alert("请输入WiFi名称");
                return;
            }

            document.getElementById("connectionStatus").innerHTML = "<p>正在连接到 " + ssid + "...</p>";

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/connect", true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(JSON.stringify({ ssid: ssid, password: password }));

            xhr.onload = function () {
                if (xhr.status == 200) {
                    var response = JSON.parse(xhr.responseText);
                    if (response.ip) {
                        document.getElementById("connectionStatus").innerHTML =
                            "<p>" + response.message + "</p>" +
                            "<p>分配的IP地址: <span class='ip-address'>" + response.ip + "</span></p>";
                    } else {
                        document.getElementById("connectionStatus").innerHTML = "<p>" + response.message + "</p>";
                    }
                    updateConfigStatus(); // 更新状态显示
                }
            }

            xhr.onerror = function () {
                document.getElementById("connectionStatus").innerHTML = "<p>连接请求失败</p>";
            }
        }

        function clearWiFiConfig() {
            if (confirm("确定要清除保存的WiFi配置吗？")) {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/clear_wifi_config", true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.send();

                xhr.onload = function () {
                    if (xhr.status == 200) {
                        var response = JSON.parse(xhr.responseText);
                        alert(response.message);
                        updateConfigStatus(); // 更新状态显示
                    }
                }

                xhr.onerror = function () {
                    alert("清除配置请求失败");
                }
            }
        }

        function capturePhoto() {
            document.getElementById("photoContainer").innerHTML = '<p class="camera-tip">正在拍照...</p><img id="capturedPhoto" class="camera-viewer" src="/capture" />';
            document.getElementById("videoContainer").innerHTML = '';
        }

        function startVideoStream() {
            document.getElementById("videoContainer").innerHTML = '<p class="camera-tip">正在打开视频流...</p><img id="videoStream" class="camera-viewer" src="/video"  />';
            document.getElementById("photoContainer").innerHTML = '';
        }

        // 电机控制函数
        function updateMotorTwoSpeed() {
            var speed = document.getElementById("motorTwoSpeed").value;
            var direction = document.getElementById("direction").checked;
            sendMotorCommand("A", direction, parseInt(speed));
            sendMotorCommand("B", direction, parseInt(speed));
            document.getElementById("motorTwoSpeedValue").innerText = speed;
        }


        function updateMotorSubSpeed() {
            var speed = document.getElementById("motorSubSpeed").value;
            document.getElementById("motorSubSpeedValue").innerText = speed;
        }

        function setMotorTwoForward() {
            document.getElementById("direction").checked = false;
            document.getElementById("directionValue").innerText = "D";
            var speed = document.getElementById("motorTwoSpeed").value;
            sendMotorCommand("A", false, parseInt(speed));
            sendMotorCommand("B", false, parseInt(speed));
        }

        function setMotorTwoBackward() {
            document.getElementById("direction").checked = true;
            document.getElementById("directionValue").innerText = "R";
            var speed = document.getElementById("motorTwoSpeed").value;
            sendMotorCommand("A", true, parseInt(speed));
            sendMotorCommand("B", true, parseInt(speed));
        }

        function setMotorTurnLeft() {
            var speed = document.getElementById("motorTwoSpeed").value;
            var subSpeed = document.getElementById("motorSubSpeed").value;

            var lowSpeed = speed - subSpeed;
            if (lowSpeed < 0) {
                lowSpeed = 0;
            }
            sendMotorCommand("A", false, parseInt(lowSpeed));
            sendMotorCommand("B", false, parseInt(speed));
        }


        function setMotorTurnRight() {
            var speed = document.getElementById("motorTwoSpeed").value;
            var subSpeed = document.getElementById("motorSubSpeed").value;
            var lowSpeed = speed - subSpeed;
            if (lowSpeed < 0) {
                lowSpeed = 0;
            }
            sendMotorCommand("A", false, parseInt(speed));
            sendMotorCommand("B", false, parseInt(lowSpeed));
        }






        function setMotorAForward() {
            var speed = document.getElementById("motorASpeed").value;
            sendMotorCommand("A", true, parseInt(speed));
        }

        function setMotorABackward() {
            var speed = document.getElementById("motorASpeed").value;
            sendMotorCommand("A", false, parseInt(speed));
        }





        function stopAllMotors() {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/stop_motors", true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send();

            xhr.onload = function () {
                if (xhr.status == 200) {
                    console.log("所有电机已停止");
                    document.getElementById("directionValue").innerText = "N";
                    // 重置滑块和显示值
                    document.getElementById("motorTwoSpeed").value = 0;
                    document.getElementById("motorTwoSpeedValue").innerText = "0";
                }
            };
        }

        function sendMotorCommand(motor, direction, speed) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/control_motor", true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(JSON.stringify({
                motor: motor,
                direction: direction,
                speed: speed
            }));

            xhr.onload = function () {
                if (xhr.status == 200) {
                    console.log("电机控制命令已发送: 电机" + motor + ", 方向:" + (direction ? "正转" : "反转") + ", 速度:" + speed);
                }
            };
        }

        // 动态背景相关代码
        document.addEventListener('DOMContentLoaded', function () {
            const canvas = document.getElementById('backgroundCanvas');
            const ctx = canvas.getContext('2d');
            let dots = [];
            const dotCount = 50;
            const maxDistance = 100;

            // 设置canvas尺寸
            function resizeCanvas() {
                // canvas.width = canvas.clientWidth;
                // canvas.height = canvas.clientHeight;

                canvas.width = window.screen.width * 0.9;
                canvas.height = canvas.clientHeight;

            }

            // 初始化点
            function initDots() {
                dots = [];
                for (let i = 0; i < dotCount; i++) {
                    dots.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        vx: (Math.random() - 0.5) * 0.5,
                        vy: (Math.random() - 0.5) * 0.5
                    });
                }
            }

            // 绘制点和连线
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 更新点位置
                for (let i = 0; i < dots.length; i++) {
                    const dot = dots[i];
                    dot.x += dot.vx;
                    dot.y += dot.vy;

                    // 边界检测
                    if (dot.x < 0 || dot.x > canvas.width) dot.vx = -dot.vx;
                    if (dot.y < 0 || dot.y > canvas.height) dot.vy = -dot.vy;
                }

                // 绘制连线
                ctx.strokeStyle = 'rgba(100, 100, 100, 0.3)';
                ctx.lineWidth = 1;
                for (let i = 0; i < dots.length; i++) {
                    for (let j = i + 1; j < dots.length; j++) {
                        const dx = dots[i].x - dots[j].x;
                        const dy = dots[i].y - dots[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < maxDistance) {
                            ctx.beginPath();
                            ctx.moveTo(dots[i].x, dots[i].y);
                            ctx.lineTo(dots[j].x, dots[j].y);
                            ctx.stroke();
                        }
                    }
                }

                // 绘制点
                ctx.fillStyle = 'rgba(150, 150, 150, 0.8)';
                for (let i = 0; i < dots.length; i++) {
                    ctx.beginPath();
                    ctx.arc(dots[i].x, dots[i].y, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // 初始化
            resizeCanvas();
            initDots();

            // 动画循环
            function animate() {
                draw();
                requestAnimationFrame(animate);
            }

            // 开始动画
            animate();

            // 窗口大小改变时重置canvas尺寸
            window.addEventListener('resize', function () {
                resizeCanvas();
                initDots();
            });
        });
    </script>
</body>

</html>