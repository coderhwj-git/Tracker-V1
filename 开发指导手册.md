# ESP32 摄像头监控项目开发指导手册

## 项目目录结构说明

### 1. 根目录
- **platformio.ini** - PlatformIO 项目配置文件，定义了开发环境、依赖库等配置
- **Readme.md** - 项目说明文档
- **开发指导手册.md** - 项目开发指导手册（本文档）

### 2. data 目录
- 存放前端网页文件，如 index.html，这些文件将被上传到 ESP32 的文件系统中
- 通过 LittleFS 文件系统访问这些文件

### 3. include 目录
- 存放项目的头文件（.h 文件）
- 采用模块化子目录结构组织，包含以下子目录：
  - **config/** - 存放配置相关头文件，如 BootStrapConfig.h
  - **hardware/** - 存放硬件相关头文件，如 Ov7670Cam.h
  - **network/** - 存放网络通信相关头文件，如 HttpServer.h
  - **utils/** - 存放工具类头文件，如 Logger.h

### 4. lib 目录
- 存放自定义库文件或第三方库文件
- 当前项目主要使用 PlatformIO 的包管理器来管理依赖库

### 5. src 目录
- 存放项目的主要源代码文件（.cpp 文件）
- 采用模块化子目录结构组织，包含以下子目录：
  - **main.cpp** - 主程序入口
  - **config/** - 存放配置相关源文件
  - **hardware/** - 存放硬件相关源文件，如 Ov7670Cam.cpp
  - **network/** - 存放网络通信相关源文件，如 HttpServer.cpp
  - **utils/** - 存放工具类源文件

### 6. test 目录
- 存放测试代码
- 当前为空，可用于编写单元测试或功能测试

### 7. .vscode 目录
- VSCode 编辑器配置文件
- 包含编辑器设置、任务配置等

## platformio.ini 配置文件关键属性说明

### 环境配置
- **[env:esp32s3_n16r8]** - 定义开发环境名称为 esp32s3_n16r8

### 平台与硬件配置
- **platform = espressif32** - 指定开发平台为 Espressif 32 系列芯片
- **board = esp32-s3-devkitc-1** - 指定目标开发板型号
- **framework = arduino** - 使用 Arduino 框架进行开发

### 构建配置
- **board_build.flash_mode = qio** - 设置 Flash 模式为 QIO（快速输入输出）
- **board_build.arduino.memory_type = qio_opi** - 设置 Arduino 内存类型
- **board_build.psram_type = opi** - 设置 PSRAM 类型为 OPI
- **board_upload.flash_size = 16MB** - 设置 Flash 大小为 16MB
- **board_build.partitions = default_16MB.csv** - 使用 16MB 分区表
- **board_build.extra_flags** - 额外编译标志，启用 PSRAM 和 OV7670 支持

### 依赖库配置
- **lib_deps** - 项目依赖的第三方库列表：
  - espressif/esp32-camera - ESP32 摄像头驱动库
  - me-no-dev/AsyncTCP - 异步 TCP 库
  - me-no-dev/ESPAsyncWebServer - 异步 Web 服务器库
  - bblanchon/ArduinoJson - Arduino JSON 处理库

### 文件系统配置
- **board_build.filesystem = littlefs** - 使用 LittleFS 文件系统
- 注释说明了上传文件系统需要执行 `pio run -t uploadfs` 命令

## 摄像头稳定性优化指南

### 问题描述
在使用 ESP32-S3 和 OV7670 摄像头时，可能会遇到堆栈溢出导致设备重启的问题。这通常是由于内存管理不当或系统资源紧张引起的。

### 解决方案

#### 1. 摄像头配置优化
- 降低摄像头时钟频率至 10MHz，以减少功耗和发热
- 设置 grab_mode 为 CAMERA_GRAB_LATEST，获取最新帧而非等待空帧
- 使用双缓冲（fb_count = 2）提高性能
- 启用 PSRAM 支持以提供更多内存空间

#### 2. 内存管理优化
- 正确释放图像缓冲区内存，确保在 JPEG 转换成功后再释放原始帧缓冲区
- 在视频流处理中增加错误恢复机制，当缓冲区不足时允许重试

#### 3. 系统栈空间配置
- 增加主任务栈空间至 8192 字节
- 为摄像头任务分配 4096 字节栈空间

#### 4. 推荐分辨率
- 避免使用 VGA 及以上分辨率，推荐使用 QVGA(320x240) 分辨率以保证系统稳定性

```
E (87767) task_wdt: Task watchdog got triggered. The following tasks did not reset the watchdog in time:
E (87767) task_wdt:  - async_tcp (CPU 1)
E (87767) task_wdt: Tasks currently running:
E (87767) task_wdt: CPU 0: IDLE0
E (87767) task_wdt: CPU 1: loopTask
E (87767) task_wdt: Aborting.
```